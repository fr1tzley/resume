<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Response Details</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/response.css') }}">
</head>
<body>
    <div id="header-container" style="width: 100%"></div>

    <div class="page-header">
        <div class="page-title">Candidate Analysis Results</div>
    </div>

    <div class="container">
        <div class="conclusion-box">
            <div class="conclusion-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                Overall Assessment
            </div>
            <div class="conclusion-value" id="conclusion_oneline">-</div>
        </div>

        <div class="metrics-grid">
            <div class="metric-box">
                <div class="metric-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Satisfied Requirements
                </div>
                <div class="metric-value" id="satisfied_requirements_count">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    Unsatisfied Requirements
                </div>
                <div class="metric-value" id="unsatisfied_requirements_count">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    Key Strengths
                </div>
                <div class="metric-value" id="strengths_count">-</div>
            </div>
            <div class="metric-box">
                <div class="metric-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Areas of Improvement
                </div>
                <div class="metric-value" id="areas_of_improvement_count">-</div>
            </div>
        </div>

        <div class="response-container">
            <div class="section-heading">Detailed Analysis</div>
            
            <div class="response-field">
                <label for="overall_conclusion">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
                    Overall Conclusion:
                </label>
                <div id="overall_conclusion" class="enhanced-textbox" name="overall_conclusion"></div>
            </div>
            
            <div class="response-field">
                <label for="satisfied_requirements">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Satisfied Requirements:
                </label>
                <div id="satisfied_requirements_list" class="enhanced-list requirements satisfied"></div>
                <textarea id="satisfied_requirements" name="satisfied_requirements" readonly style="display: none;"></textarea>
            </div>
            
            <div class="response-field">
                <label for="unsatisfied_requirements">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    Unsatisfied Requirements:
                </label>
                <div id="unsatisfied_requirements_list" class="enhanced-list requirements unsatisfied"></div>
                <div id="unsatisfied_requirements" name="unsatisfied_requirements"  class="enhanced-textbox" style="display: none;">None!</div>
            </div>
            
            <div class="response-field">
                <label for="interview_fit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Interview Fit:
                </label>
                <div id="interview_fit" class="enhanced-textbox" name="interview_fit"></div>
            </div>
            
            <div class="response-field">
                <label for="strengths">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    Strengths:
                </label>
                <div id="strengths_list" class="enhanced-list strengths"></div>
                <textarea id="strengths" name="strengths" readonly style="display: none;"></textarea>
            </div>
            
            <div class="response-field">
                <label for="areas_of_improvement">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Areas of Improvement:
                </label>
                <div id="improvements_list" class="enhanced-list improvements"></div>
                <textarea id="areas_of_improvement" name="areas_of_improvement" readonly style="display: none;"></textarea>
            </div>
            <div class="response-field" id="custom_questions_display" style="display: none;">
                <label for="custom_questions" >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 5px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Custom Questions:
                </label>
                <div id="custom_questions_list" class="enhanced-list custom-questions"></div>
                <textarea id="custom_questions" name="custom_questions" readonly style="display: none;"></textarea>
            </div>

        </div>

        <div class="nav-buttons">
            <button onclick="window.location.href='./records'" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Back to Records
            </button>
            <button onclick="window.print()" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                Print Report
            </button>
        </div>
    </div>

    <script type="text/babel" src="{{ url_for('static', filename='js/header.js') }}"></script>

    <script type="text/babel">
         window.addEventListener('load', () => {
        if (ReactDOM && window.DashboardHeader) {
        const headerRoot = ReactDOM.createRoot(document.getElementById('header-container'));
        headerRoot.render(React.createElement(window.DashboardHeader));
        } else {
        console.error('React or DashboardHeader component not loaded properly');
        }
    });
    </script>

    <script>
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
    
            const paramsToInputs = {
                overall_conclusion: 'overall_conclusion',
                requirements_fit: 'requirements_fit',
                unsatisfied_requirements: "unsatisfied_requirements",
                satisfied_requirements: "satisfied_requirements",
                interview_fit: 'interview_fit',
                strengths: 'strengths',
                areas_of_improvement: 'areas_of_improvement',
                satisfied_requirements_count: 'satisfied_requirements_count',
                unsatisfied_requirements_count: 'unsatisfied_requirements_count',
                strengths_count: 'strengths_count',
                custom_questions: 'custom_questions',
                areas_of_improvement_count: 'areas_of_improvement_count',
                conclusion_oneline: "conclusion_oneline"
            };
    
            for (const [param, inputId] of Object.entries(paramsToInputs)) {
                try {
                    const element = document.getElementById(inputId);
                    const value = urlParams.get(param);
                    if (value !== null) {
                        if (inputId == "custom_questions") {
                            document.getElementById("custom_questions_display").style = "display: block;";
                        }
                        const decodedValue = decodeURIComponent(value.replace(/%(?![0-9][0-9a-fA-F]+)/g, '%25'));
                        
                        if (element.tagName && element.tagName === 'TEXTAREA') {
                            element.value = decodedValue;
                            // Auto-resize textarea
                            element.style.height = 'auto';
                            element.style.height = element.scrollHeight + 'px';
                            
                            // Handle special cases for enhanced lists
                            if (inputId === 'strengths') {
                                populateEnhancedList('strengths_list', decodedValue);
                            } else if (inputId === 'areas_of_improvement') {
                                populateEnhancedList('improvements_list', decodedValue);
                            } else if (inputId === 'satisfied_requirements') {
                                parseRequirements(decodedValue, 'satisfied_requirements_list');
                            } else if (inputId === 'unsatisfied_requirements') {
                                parseRequirements(decodedValue, 'unsatisfied_requirements_list');
                            } else if (inputId === 'custom_questions') {
                                document.getElementById("custom_questions_display").style = "display: block;";
                                parseCustomQuestions(decodedValue, 'custom_questions_list');
                        }
                        } else {
                            element.innerHTML = decodedValue;
                        }
                    }
                } catch(error) {
                    console.log(error);
                    continue;
                }
            }
            
            // Function to parse requirements and create enhanced list
            function parseRequirements(textContent, listElementId) {
                const listElement = document.getElementById(listElementId);
                if (!listElement) return;
                
                // Clear any existing content
                listElement.innerHTML = '';
                
                const lines = textContent.split('\n');
                let currentItem = null;
                let currentExplanation = '';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if line starts a new requirement
                    if (line.startsWith('Requirement number')) {
                        // If we already have a requirement, add it to the list
                        if (currentItem) {
                            currentItem.querySelector('.requirement-explanation').textContent = currentExplanation.trim();
                            listElement.appendChild(currentItem);
                        }
                        
                        // Create a new requirement item
                        currentItem = document.createElement('div');
                        currentItem.className = 'list-item';
                        
                        // Extract the requirement text from the line
                        const requirementMatch = line.match(/Requirement number \d+:\s+(.*?)\s+:/);
                        if (requirementMatch && requirementMatch[1]) {
                            const titleElement = document.createElement('div');
                            titleElement.className = 'requirement-title';
                            titleElement.textContent = requirementMatch[1];
                            
                            const explanationElement = document.createElement('div');
                            explanationElement.className = 'requirement-explanation';
                            
                            currentItem.appendChild(titleElement);
                            currentItem.appendChild(explanationElement);
                            
                            // Reset explanation for the new requirement
                            currentExplanation = '';
                        }
                    } 
                    // If not a new requirement and not empty, it's part of the explanation
                    else if (line && currentItem) {
                        currentExplanation += line + '\n';
                    }
                }
                
                // Add the last requirement
                if (currentItem) {
                    currentItem.querySelector('.requirement-explanation').textContent = currentExplanation.trim();
                    listElement.appendChild(currentItem);
                }
                
                // If no requirements were found, show the original textarea
                if (listElement.children.length === 0) {
                    document.getElementById(listElementId.replace('_list', '')).style.display = 'block';
                    listElement.style.display = 'none';
                }
            }

            // Function to parse custom questions
            function parseCustomQuestions(textContent, listElementId) {
                const listElement = document.getElementById(listElementId);
                if (!listElement) return;
                
                // Clear any existing content
                listElement.innerHTML = '';
                
                // Parse the questions which are formatted like:
                // 1.[Full question text]: [Question answer]
                // 2.[Full question text]: [Question answer]
                
                const regex = /(\d+)\.\s*(.*?\??):\s*([\s\S]*?)(?=\n\d+\.\s|$)/g;
                let match;
                let foundQuestions = false;
                
                while ((match = regex.exec(textContent + "\n")) !== null) {
                    foundQuestions = true;
                    const questionNumber = match[1];
                    const questionText = match[2];
                    const answer = match[3].trim();
                    
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    
                    const titleElement = document.createElement('div');
                    titleElement.className = 'requirement-title';
                    titleElement.textContent = `${questionNumber}. ${questionText}`;
                    
                    const explanationElement = document.createElement('div');
                    explanationElement.className = 'requirement-explanation';
                    explanationElement.textContent = answer;
                    
                    listItem.appendChild(titleElement);
                    listItem.appendChild(explanationElement);
                    listElement.appendChild(listItem);
                }
                
                // If no questions were found, show the original textarea
                if (!foundQuestions) {
                    document.getElementById(listElementId.replace('_list', '_and_answers')).style.display = 'block';
                    listElement.style.display = 'none';
                }
            }
            
            // Function to populate strengths and improvements
            function populateEnhancedList(listId, textContent) {
                const list = document.getElementById(listId);
                if (!list) return;
                
                // Clear any existing content
                list.innerHTML = '';
                
                // Split by newlines and process each line
                const lines = textContent.split('\n');
                
                lines.forEach(line => {
                    // Check if line has content (starts with '-' or not)
                    const trimmedLine = line.trim();
                    if (trimmedLine.length > 0) {
                        const listItem = document.createElement('div');
                        listItem.className = 'list-item';
                        
                        // Remove the leading '-' if it exists
                        if (trimmedLine.startsWith('-')) {
                            listItem.textContent = trimmedLine.substring(1).trim();
                        } else {
                            listItem.textContent = trimmedLine;
                        }
                        
                        list.appendChild(listItem);
                    }
                });
                
                // If no items were found, fallback to show the original textarea
                if (list.children.length === 0) {
                    document.getElementById(listId.replace('_list', '')).style.display = 'block';
                    list.style.display = 'none';
                }
            }
    
            // Add event listener to dynamically resize on input
            document.querySelectorAll('textarea:not([style*="display: none"])').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
                
                // Initialize heights
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });

            // Add color coding to metric values for better visualization
            const satisfiedCount = document.getElementById('satisfied_requirements_count');
            const unsatisfiedCount = document.getElementById('unsatisfied_requirements_count');
            
            if (satisfiedCount && satisfiedCount.textContent !== '-') {
                satisfiedCount.style.color = '#4285f4';  // Google blue
            }
            
            if (unsatisfiedCount && unsatisfiedCount.textContent !== '-') {
                unsatisfiedCount.style.color = '#ea4335';  // Google red
            }

            document.getElementById('strengths_count').style.color = '#34a853';  // Google green
            document.getElementById('areas_of_improvement_count').style.color = '#fbbc05';  // Google yellow
        };
    </script>
</body>
</html>